# Tools

import pdfminer

import requests

import urllib2

import olefile

import os

import traceback

import time

import re

import random

import math

import sys

import Queue

import time

import threading

import cgi

from termcolor import colored

from pdfminer.pdfparser import PDFParser

from pdfminer.pdfdocument import PDFDocument

from bs4 import BeautifulSoup

from bluto\_logging import info, INFO\_LOG\_FILE

from get\_file import get\_user\_agents

from search import doc\_bing, doc\_exalead

from general import get\_size

​

​

​

def action\_download\(doc\_list, docs\):

 info\('Document Download Started'\)

 i = 0

 download\_list = \[\]

 initial\_count = 0

 print 'Gathering Live Documents For Metadata Mining\n'

 headers = {

 'User-Agent': 'Mozilla/5.0 \(Windows; U; Windows NT 6.0; pl; rv:1.9.1.2\) Gecko/20090729 Firefox/3.5.2 GTB7.1 \( .NET CLR 3.5.30729',

 'Referer': 'https://www.google.co.uk/',

 'Accept-Language': 'en-US,en;q=0.5',

 'Cache-Control': 'no-cache'

 }

 for doc in doc\_list:

 doc = doc.replace\(' ', '%20'\)

 try:

 r = requests.get\(doc.encode\('utf-8'\), headers=headers, verify=False\)

 if r.status\_code == 404:

 r.raise\_for\_status\(\)

​

 if r.status\_code == 200:

 params = cgi.parse\_header\(r.headers.get\('Content-Disposition', ''\)\)\[-1\]

 if 'filename' not in params:

 filename = str\(doc\).replace\('%20', ' '\).split\('/'\)\[-1\]

 with open\(docs + filename, "w"\) as code:

 i += 1

 code.write\(r.content\)

 code.close\(\)

 initial\_count += 1

 print\('\tDownload Count: {}\r'.format\(str\(initial\_count\)\)\),

 info\(str\(doc\).replace\('%20', ' '\)\)

 download\_list.append\(str\(doc\).replace\('%20', ' '\)\)

​

 continue

 else:

 filename\_t = re.search\('filename="\(.\*\)"', r.headers\['content-disposition'\]\)

 filename = filename\_t.group\(1\)

​

 with open\(docs + filename, "w"\) as code:

 i += 1

 code.write\(r.content\)

 code.close\(\)

 initial\_count += 1

 print\('\tDownload Count: {}\r'.format\(str\(initial\_count\)\)\),

 download\_list.append\(str\(doc\).replace\('%20', ' '\)\)

 info\(str\(doc\).replace\('%20', ' '\)\)

 continue

​

​

 except ValueError:

 info\('No Filename in header'\)

 pass

 except AttributeError:

 pass

 except IOError:

 info\('Not Found: {}'.format\(str\(doc\).replace\('%20', ' '\)\)\)

 pass

 except requests.exceptions.HTTPError:

 info\('Error: File Not Found Server Side: HTTPError'\)

 pass

 except requests.exceptions.ConnectionError:

 info\('Error: File Not Found Server Side: ConnectionError'\)

 pass

 except KeyError:

 pass

 except UnboundLocalError:

 pass

 except Exception:

 info\('An Unhandled Exception Has Occured, Please Check The Log For Details\n' + INFO\_LOG\_FILE\)

 info\(str\(doc\).replace\('%20', ' '\)\)

 pass

 if i &lt; 1:

 return download\_list

 data\_size = get\_size\(docs\)

 print '\tData Downloaded: {}MB'.format\(str\(math.floor\(data\_size\)\)\)

 info\('Documents Downloaded: {}'.format\(initial\_count\)\)

 return download\_list

​

​

def doc\_search\(domain, USERAGENT\_F, prox\):

 q1 = Queue.Queue\(\)

 q2 = Queue.Queue\(\)

 t1 = threading.Thread\(target=doc\_bing, args=\(domain, USERAGENT\_F, prox, q1\)\)

 t2 = threading.Thread\(target=doc\_exalead, args=\(domain, USERAGENT\_F, prox, q2\)\)

 t1.start\(\)

 t2.start\(\)

 t1.join\(\)

 t2.join\(\)

 bing = q1.get\(\)

 exalead = q2.get\(\)

 list\_d = bing + exalead

 return list\_d

​

​

\#Extract Author PDF

def pdf\_read\(pdf\_file\_list\):

 info\('Extracting PDF MetaData'\)

 software\_list = \[\]

 user\_names = \[\]

 for filename in pdf\_file\_list:

 info\(filename\)

 try:

​

 fp = open\(filename, 'rb'\)

 parser = PDFParser\(fp\)

 doc = PDFDocument\(parser\)

 software = re.sub\('\[^0-9a-zA-Z\]+', ' ', doc.info\[0\]\['Creator'\]\)

 person = re.sub\('\[^0-9a-zA-Z\]+', ' ', doc.info\[0\]\['Author'\]\)

 if person:

 oddity = re.match\('\(\s\w\s+\(\w\s+\)+\w\)', person\)

 if oddity:

 oddity = str\(oddity.group\(1\)\).replace\(' ', ''\)

 user\_names.append\(str\(oddity\).title\(\)\)

 else:

 user\_names.append\(str\(person\).title\(\)\)

 if software:

 oddity2 = re.match\('\(\s\w\s+\(\w\s+\)+\w\)', software\)

 if oddity2:

 oddity2 = str\(oddity2.group\(1\)\).replace\(' ', ''\)

 software\_list.append\(oddity2\)

 else:

 software\_list.append\(software\)

 except IndexError:

 continue

 except pdfminer.pdfparser.PDFSyntaxError:

 continue

 except KeyError:

 continue

 except TypeError:

 continue

 except Exception:

 info\('An Unhandled Exception Has Occured, Please Check The Log For Details' + INFO\_LOG\_FILE\)

 continue

 info\('Finished Extracting PDF MetaData'\)

 return \(user\_names, software\_list\)

​

​

​

\#Extract Author MS FILES

def ms\_doc\(ms\_file\_list\):

 software\_list = \[\]

 user\_names = \[\]

 info\('Extracting MSDOCS MetaData'\)

 for filename in ms\_file\_list:

 try:

 data = olefile.OleFileIO\(filename\)

 meta = data.get\_metadata\(\)

 author = re.sub\('\[^0-9a-zA-Z\]+', ' ', meta.author\)

 company = re.sub\('\[^0-9a-zA-Z\]+', ' ', meta.company\)

 software = re.sub\('\[^0-9a-zA-Z\]+', ' ', meta.creating\_application\)

 save\_by = re.sub\('\[^0-9a-zA-Z\]+', ' ', meta.last\_saved\_by\)

 if author:

 oddity = re.match\('\(\s\w\s+\(\w\s+\)+\w\)', author\)

 if oddity:

 oddity = str\(oddity.group\(1\)\).replace\(' ', ''\)

 user\_names.append\(str\(oddity\).title\(\)\)

 else:

 user\_names.append\(str\(author\).title\(\)\)

 if software:

 oddity2 = re.match\('\(\s\w\s+\(\w\s+\)+\w\)', software\)

 if oddity2:

 oddity2 = str\(oddity2.group\(1\)\).replace\(' ', ''\)

 software\_list.append\(oddity2\)

 else:

 software\_list.append\(software\)

​

 if save\_by:

 oddity3 = re.match\('\(\s\w\s+\(\w\s+\)+\w\)', save\_by\)

 if oddity3:

 oddity3 = str\(oddity3.group\(1\)\).replace\(' ', ''\)

 user\_names.append\(str\(oddity3\).title\(\)\)

 else:

 user\_names.append\(str\(save\_by\).title\(\)\)

​

 except Exception:

 pass

 info\('Finished Extracting MSDOC MetaData'\)

 return \(user\_names, software\_list\)

​

\#Modules takes in DOMAIN, PROX, USERAGENTS outputs user\_names, software\_list

def doc\_start\(domain, USERAGENT\_F, prox, q\):

 ms\_list\_ext = \('.docx', '.pptx', '.xlsx', '.doc', '.xls', '.ppt'\)

 ms\_file\_list = \[\]

 pdf\_file\_list = \[\]

 info\('Let The Hunt Begin'\)

 domain\_r = domain.split\('.'\)

 if not os.path.exists\(os.path.expanduser\('~/Bluto/doc/{}'.format\(domain\_r\[0\]\)\)\):

 os.makedirs\(os.path.expanduser\('~/Bluto/doc/{}'.format\(domain\_r\[0\]\)\)\)

​

 location = os.path.expanduser\('~/Bluto/doc/{}/'.format\(domain\_r\[0\]\)\)

 info\('Data Folder Created ' + location\)

 docs = os.path.expanduser\(location\)

 doc\_list = doc\_search\(domain, USERAGENT\_F, prox\)

​

 if doc\_list == \[\]:

 q.put\(None\)

 return

 doc\_list = set\(sorted\(doc\_list\)\)

 download\_list = action\_download\(doc\_list, docs\)

 download\_count = len\(download\_list\)

​

 for root, dirs, files in os.walk\(docs\):

 for filename in files:

 if str\(filename\).endswith\(ms\_list\_ext\):

 ms\_file\_list.append\(os.path.join\(root, filename\)\)

 if str\(filename\).endswith\('.pdf'\):

 pdf\_file\_list.append\(os.path.join\(root, filename\)\)

​

 if ms\_file\_list and pdf\_file\_list:

 user\_names\_ms, software\_list\_ms = ms\_doc\(ms\_file\_list\)

 user\_names\_pdf, software\_list\_pdf = pdf\_read\(pdf\_file\_list\)

 user\_names\_t = user\_names\_ms + user\_names\_pdf

 software\_list\_t = software\_list\_ms + software\_list\_pdf

​

 elif ms\_file\_list:

 user\_names\_ms, software\_list\_ms = ms\_doc\(ms\_file\_list\)

 user\_names\_t = user\_names\_ms

 software\_list\_t = software\_list\_ms

​

 elif pdf\_file\_list:

 user\_names\_pdf, software\_list\_pdf = pdf\_read\(pdf\_file\_list\)

 user\_names\_t = user\_names\_pdf

 software\_list\_t = software\_list\_pdf

 else:

 user\_names\_t = \[\]

 software\_list\_t = \[\]

​

 if user\_names\_t and software\_list\_t:

 user\_names = sorted\(set\(user\_names\_t\)\)

 software\_list = sorted\(set\(software\_list\_t\)\)

 info\('The Hunt Ended'\)

 q.put\(\(user\_names, software\_list, download\_count, download\_list\)\)

​

 elif software\_list\_t:

 software\_list = sorted\(set\(software\_list\_t\)\)

 user\_names = \[\]

 info\('The Hunt Ended'\)

 q.put\(\(user\_names, software\_list, download\_count, download\_list\)\)

​

 elif user\_names\_t:

 user\_names = sorted\(set\(user\_names\_t\)\)

 software\_list = \[\]

 info\('The Hunt Ended'\)

 q.put\(\(user\_names, software\_list, download\_count, download\_list\)\)

 elif \(user\_names\_t and software\_list\) is None:

 q.put\(None\)

​

